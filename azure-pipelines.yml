# Azure DevOps Pipeline dla Kalkulatora
# Automatyczne budowanie i publikacja do Azure Static Web Apps

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - src/*
      - package.json

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  - group: AzureSecrets
  - name: nodeVersion
    value: '20.x'

stages:
  - stage: Build
    displayName: 'ğŸ”¨ Build Stage'
    jobs:
      - job: BuildJob
        displayName: 'Build and Minify'
        steps:
          - task: NodeTool@0
            displayName: 'ğŸŸ¢ Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'ğŸ“¦ Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npm_config_cache)

          - script: |
              echo "ğŸ“¦ Installing dependencies..."
              npm ci
            displayName: 'ğŸ“¦ Install Dependencies'

          - script: |
              echo "ğŸ¨ Compiling SCSS to CSS..."
              npm run sass
              echo "âœ… SCSS compiled successfully"
            displayName: 'ğŸ¨ Compile Sass â†’ CSS (Etap 1)'

          - script: |
              echo "ğŸ—œï¸ Minifying CSS..."
              npm run minify:css
              echo "âœ… CSS minified successfully"
            displayName: 'ğŸ—œï¸ Minify CSS (Etap 2)'

          - script: |
              echo "ğŸ—œï¸ Minifying JavaScript..."
              npm run minify:js
              echo "âœ… JavaScript minified successfully"
            displayName: 'ğŸ—œï¸ Minify JavaScript (Etap 2)'

          - script: |
              echo "ğŸ—œï¸ Minifying HTML..."
              npm run minify:html
              echo "âœ… HTML minified successfully"
            displayName: 'ğŸ—œï¸ Minify HTML (Etap 2)'

          - script: |
              echo "ğŸ“‹ Copying config files..."
              npm run copy:config
            displayName: 'ğŸ“‹ Copy Config Files'

          - script: |
              echo "ğŸ“Š === BUILD SUMMARY ==="
              echo "Source files (src/):"
              ls -lh src/
              echo ""
              echo "Built files (dist/):"
              ls -lh dist/
              echo ""
              echo "File sizes:"
              echo "CSS Source: $(wc -c < src/styles.scss) bytes"
              echo "CSS Minified: $(wc -c < dist/styles.min.css) bytes"
              echo "JS Source: $(wc -c < src/script.js) bytes"
              echo "JS Minified: $(wc -c < dist/script.min.js) bytes"
              echo "HTML Source: $(wc -c < src/index.html) bytes"
              echo "HTML Minified: $(wc -c < dist/index.html) bytes"
              echo ""
              echo "âœ… Build completed successfully!"
            displayName: 'ğŸ“Š Build Summary'

          - task: PublishBuildArtifacts@1
            displayName: 'ğŸ“¤ Publish Build Artifacts'
            inputs:
              PathtoPublish: 'dist'
              ArtifactName: 'calculator-build'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'ğŸš€ Deploy Stage'
    dependsOn: Build
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToAzure
        displayName: 'Deploy to Azure Static Web Apps'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@1
                  displayName: 'ğŸ“¥ Download Build Artifacts'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'calculator-build'
                    downloadPath: '$(System.ArtifactsDirectory)'

                - task: AzureStaticWebApp@0
                  displayName: 'ğŸš€ Deploy to Azure Static Web Apps'
                  inputs:
                    app_location: '$(System.ArtifactsDirectory)/calculator-build'
                    skip_app_build: true
                    azure_static_web_apps_api_token: $(AZURE_STATIC_WEB_APPS_API_TOKEN)

                - script: |
                    echo "âœ… Deployment completed successfully!"
                    echo "ğŸŒ Application is now live!"
                  displayName: 'âœ… Deployment Summary'
